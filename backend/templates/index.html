<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MKg E-Commerce Site</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div id="head">
    <h1>MKg E-Commerce Site</h1>
    <nav>
      <ul>
        <li><a href="{{ url_for('home') }}">Home</a></li>
        <li><a href="{{ url_for('cart') }}">Cart(<span id="cart-count">0</span>)</a></li>
        <li><a href="{{ url_for('login') }}">Login</a></li>
        <li><a href="{{ url_for('admin') }}">Admin</a></li>
        <li id="user-info" style="display: none;"></li>
        <li id="logout-link" style="display: none;"><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </nav>
  </div>

  <div id="content">
    <h1>Welcome to the MKg E-Commerce Site</h1>
    <p>Let's do something amazing!</p>

    {% set categories = {} %}
    {% for product in products %}
      {% set cat = product[5] or 'Uncategorized' %}
      {% if categories[cat] is not defined %}
        {% set _ = categories.update({cat: []}) %}
      {% endif %}
      {% set _ = categories[cat].append(product) %}
    {% endfor %}

    {% for category, items in categories.items() %}
      <h2>{{ category }}</h2>
      <div id="catalog">
        {% for product in items %}
          {% set key = product[1]|lower|replace(' ', '') %}
          <div class="item product-card">
            <h3>{{ product[1] }}</h3>
            <div class="image-container">
              <img src="{{ url_for('static', filename=product[4] if product[4] else 'images/default.jpg') }}" alt="{{ product[1] }}">
            </div>
            <p>{{ product[3] }}</p>
            <p>Price: ${{ product[2] }}</p>
            <p><strong>Available: {{ product[6] }}</strong></p>

            <div class="quantity-controls">
              <button onclick="decreaseQuantity('{{ key }}')" {% if product[6] <= 0 %}disabled{% endif %}>-</button>
              <span id="qty-{{ key }}">0</span>
              <button onclick="increaseQuantity('{{ key }}')" {% if product[6] <= 0 %}disabled{% endif %}>+</button>
            </div>

            <button onclick="addToCart('{{ key }}')" {% if product[6] <= 0 %}disabled{% endif %}>Add to Cart</button>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div id="footer">
    <p>&copy; 2025 Your Company</p>
  </div>

  <script>
    function increaseQuantity(productId) {
      const qtySpan = document.getElementById("qty-" + productId);
      let qty = parseInt(qtySpan.textContent, 10);
      qtySpan.textContent = qty + 1;
    }

    function decreaseQuantity(productId) {
      const qtySpan = document.getElementById("qty-" + productId);
      let qty = parseInt(qtySpan.textContent, 10);
      if (qty > 0) qtySpan.textContent = qty - 1;
    }

    function addToCart(productId) {
      const qty = parseInt(document.getElementById("qty-" + productId).textContent, 10);
      if (qty > 0) {
        let cart = JSON.parse(localStorage.getItem("cart")) || {};
        cart[productId] = (cart[productId] || 0) + qty;
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        window.location.href = "{{ url_for('cart') }}";
      } else {
        alert("Please select at least 1 unit.");
      }
    }

    function updateCartCount() {
      let cart = JSON.parse(localStorage.getItem("cart")) || {};
      let totalItems = Object.values(cart).reduce((acc, qty) => acc + qty, 0);
      document.getElementById("cart-count").textContent = totalItems;
    }

    function updateUserDisplay() {
      const username = localStorage.getItem('username');
      const userInfo = document.getElementById('user-info');
      const logoutLink = document.getElementById('logout-link');

      if (username) {
        userInfo.textContent = `Hello, ${username}`;
        userInfo.style.display = 'inline';
        logoutLink.style.display = 'inline';
      }
    }

    function logout() {
      localStorage.removeItem('username');
      localStorage.removeItem('cart');
      window.location.href = '/login';
    }

    window.onload = function () {
      updateUserDisplay();
      updateCartCount();
    };
  </script>
</body>
</html>
